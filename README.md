Note: Generated by Claude, don't actually use this!

# Registry Redirect Proxy

An Nginx + Lua-based redirect proxy for Docker registries (specifically designed for Zot) that validates JWT tokens and redirects blob/manifest downloads to S3 presigned URLs.

## Features

- **JWT Authentication**: Validates JWT tokens with HMAC (HS256/HS384/HS512) signatures
- **Permission Checking**: Verifies token has 'pull' permissions for the requested repository
- **S3 Integration**: Generates AWS S3 v4 presigned URLs valid for 20 minutes
- **Docker Registry v2 API**: Handles blob and manifest download endpoints
- **Flexible S3 Support**: Works with AWS S3, MinIO, and other S3-compatible storage

## Architecture

```
Client Request → Nginx (JWT Validation) → S3 Presigned URL → 307 Redirect → Client downloads from S3
```

The proxy intercepts Docker registry v2 API requests for blobs and manifests, validates the JWT token, checks permissions, generates a time-limited S3 presigned URL, and redirects the client to download directly from S3.

## How It Works

1. **Request Interception**: Nginx captures requests matching registry v2 blob/manifest patterns
2. **JWT Validation**: Lua script extracts and validates the JWT token from the Authorization header
3. **Permission Check**: Verifies the token includes 'pull' access for the requested repository
4. **S3 URL Generation**: Creates an AWS v4 signed URL valid for 20 minutes
5. **Redirect**: Returns 307 Temporary Redirect to the S3 URL

### Example Flow

Request:
```
GET /v2/v2/742a2ce690a4ee1f5e75e31bda41aa70/manifests/sha256:174a6efee4f1d6a8d7c15d6fd159e89a9b8413918008dd8029f9579451bf5b7d
Authorization: Bearer eyJhbGci...
```

JWT Payload (decoded):
```json
{
  "access": [
    {
      "type": "repository",
      "name": "v2/742a2ce690a4ee1f5e75e31bda41aa70",
      "actions": ["pull"]
    }
  ],
  "exp": 1734567890
}
```

Response:
```
HTTP/1.1 307 Temporary Redirect
Location: https://my-bucket.s3.amazonaws.com/docker/registry/v2/...?X-Amz-Algorithm=...
```

## Prerequisites

- Docker and Docker Compose
- S3 bucket with your registry data
- JWT secret key (shared with your authentication service)
- S3 credentials (access key and secret key)

## Installation

1. Clone the repository:
```bash
git clone <repository-url>
cd registry-redirect-proxy
```

2. Copy the environment configuration:
```bash
cp .env.example .env
```

3. Edit `.env` with your configuration:
```bash
JWT_SECRET=your-jwt-secret-here
S3_BUCKET=your-registry-bucket
S3_REGION=us-east-1
S3_ACCESS_KEY=your-access-key
S3_SECRET_KEY=your-secret-key
```

4. Build and start the services:
```bash
docker-compose up -d
```

## Configuration

### Environment Variables

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `JWT_SECRET` | Yes | - | Secret key for JWT HMAC validation |
| `S3_BUCKET` | Yes | - | S3 bucket name containing registry data |
| `S3_REGION` | No | `us-east-1` | AWS region of the S3 bucket |
| `S3_ACCESS_KEY` | Yes | - | AWS access key ID |
| `S3_SECRET_KEY` | Yes | - | AWS secret access key |
| `S3_ENDPOINT` | No | - | Custom S3 endpoint (for MinIO, etc.) |

### JWT Token Format

The proxy expects JWT tokens with the following structure:

```json
{
  "access": [
    {
      "type": "repository",
      "name": "repository/path",
      "actions": ["pull", "push"]
    }
  ],
  "exp": 1234567890,
  "nbf": 1234567000
}
```

Supported algorithms: HS256, HS384, HS512

### S3 Storage Structure

The proxy assumes the following S3 key structure:

**Blobs:**
```
docker/registry/v2/blobs/sha256/{first-2-chars}/{full-hash}/data
```

**Manifests:**
```
docker/registry/v2/repositories/{repo-path}/_manifests/tags/{tag}/current/link
```

Adjust the `build_s3_key()` function in [lua/redirect_handler.lua](lua/redirect_handler.lua) if your structure differs.

## Usage

### With Docker Clients

Configure your Docker client to use the proxy:

```bash
# Login (if using authentication)
docker login localhost:8080

# Pull images through the proxy
docker pull localhost:8080/repository/image:tag
```

### Testing

Health check endpoint:
```bash
curl http://localhost:8080/health
```

Test with a JWT token:
```bash
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  http://localhost:8080/v2/your-repo/blobs/sha256:abc123...
```

## Project Structure

```
.
├── Dockerfile              # OpenResty container with Lua dependencies
├── docker-compose.yml      # Multi-container setup
├── nginx.conf              # Nginx configuration
├── lua/
│   ├── jwt.lua            # JWT validation module
│   ├── s3.lua             # S3 presigned URL generation
│   └── redirect_handler.lua # Main request handler
├── zot-config.json        # Example Zot registry configuration
├── .env.example           # Environment variables template
└── README.md              # This file
```

## Customization

### Changing Token Expiration

Edit the expiration time in [lua/redirect_handler.lua](lua/redirect_handler.lua#L130):

```lua
1200  -- 20 minutes in seconds
```

### Custom S3 Key Structure

Modify the `build_s3_key()` function in [lua/redirect_handler.lua](lua/redirect_handler.lua) to match your S3 storage layout.

### Additional Endpoints

Add more location blocks in [nginx.conf](nginx.conf) to handle other registry endpoints.

## Troubleshooting

### Check Logs

```bash
# Proxy logs
docker-compose logs -f proxy

# Nginx error logs
docker exec registry-redirect-proxy cat /var/log/nginx/error.log

# Nginx access logs
docker exec registry-redirect-proxy cat /var/log/nginx/access.log
```

### Common Issues

1. **401 Unauthorized**: Check JWT_SECRET matches your token issuer
2. **403 Forbidden**: Verify token includes correct repository and 'pull' action
3. **500 Internal Server Error**: Check S3 credentials and bucket configuration
4. **S3 403 Errors**: Ensure S3 key structure matches your actual storage layout

### Debug Mode

Enable Lua debug logging in [nginx.conf](nginx.conf):

```nginx
error_log /var/log/nginx/error.log debug;
```

## Security Considerations

- Store JWT_SECRET and S3 credentials securely (use secrets management)
- Use HTTPS in production (add TLS termination)
- Implement rate limiting for production use
- Regularly rotate S3 credentials
- Set appropriate CORS policies on S3 bucket
- Consider implementing request logging and monitoring

## Performance

- Presigned URLs are valid for 20 minutes (configurable)
- No data proxying - clients download directly from S3
- Minimal CPU/memory overhead (just JWT validation and URL signing)
- Horizontally scalable (stateless)

## License

MIT

## Contributing

Pull requests welcome! Please ensure:
- Code follows existing style
- Tests pass (if applicable)
- Documentation is updated

## Support

For issues and questions, please open a GitHub issue.